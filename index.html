<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Antonios chruch in Minya |  كنيسة القديس العظيم الأنبا أنطونيوس بالمنيا</title>
    
    <!-- خط تجوال العربي -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- مكتبة أيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- مكتبة Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --primary-blue: #1a2b49; /* أزرق غامق كنسي */
            --secondary-blue: #2c426b;
            --accent-gold: #c5a059;   /* ذهبي */
            --accent-gold-hover: #b08d4b;
            --text-white: #ffffff;
            --text-dark: #333333;
            --bg-light: #f4f6f9;
            --success: #28a745;
            --danger: #dc3545;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; 
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }
        
        body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; display: flex; flex-direction: column; }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--text-white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-icon { font-size: 2.5rem; color: var(--accent-gold); }
        .site-title h1 { font-size: 1.5rem; font-weight: 900; color: var(--accent-gold); }
        .site-title p { font-size: 0.9rem; opacity: 0.9; }
        
        nav ul { display: flex; list-style: none; gap: 20px; }
        nav a { color: var(--text-white); text-decoration: none; font-weight: 500; transition: 0.3s; cursor: pointer; }
        nav a:hover, nav a.active { color: var(--accent-gold); }
        
        .user-menu { position: relative; display: flex; align-items: center; gap: 10px; }
        .btn-gold { background: var(--accent-gold); color: white; border: none; padding: 8px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-gold:hover { background: var(--accent-gold-hover); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 2px solid var(--accent-gold); color: var(--accent-gold); padding: 6px 18px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-outline:hover { background: var(--accent-gold); color: white; }

        /* Main Layout */
        main { flex: 1; padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Sections */
        .page-section { display: none; animation: fadeIn 0.5s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Hero */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border-top: 5px solid var(--accent-gold);
        }
        .hero h2 { color: var(--primary-blue); font-size: 2.5rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; color: #666; max-width: 700px; margin: 0 auto; }

        /* Cards Grid */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); transition: 0.3s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); }
        .card::before { content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 100%; background: var(--accent-gold); }
        .card h3 { color: var(--primary-blue); margin-bottom: 10px; }
        .card-meta { color: #777; font-size: 0.9rem; margin-bottom: 15px; display: flex; gap: 10px; }
        
        /* Services */
        .service-card { text-align: center; border: 1px solid #eee; }
        .service-icon { font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem; }
        .locked-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .lock-icon { font-size: 2rem; color: var(--accent-gold); margin-bottom: 10px; }

        /* Forms */
        .form-container { max-width: 500px; margin: 2rem auto; background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-blue); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .form-group input:focus { border-color: var(--accent-gold); outline: none; }
        
        /* Admin Dashboard */
        .admin-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; min-height: 80vh; }
        .admin-sidebar { background: var(--primary-blue); color: white; border-radius: var(--radius); padding: 1rem; }
        .admin-menu-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .admin-menu-item:hover, .admin-menu-item.active { background: rgba(255,255,255,0.1); color: var(--accent-gold); }
        .admin-content { background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        
        /* Admin Tabs inside Content */
        .admin-sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .sub-tab { padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; }
        .sub-tab.active { background: var(--primary-blue); color: white; }

        /* Question Builder Styles */
        .question-block { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; position: relative; }
        .remove-q-btn { position: absolute; top: 10px; left: 10px; color: var(--danger); cursor: pointer; font-size: 1.2rem; }
        .option-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background-color: var(--primary-blue); color: white; }
        tr:hover { background-color: #f9f9f9; }

        /* Certificate Canvas (Hidden) */
        #certCanvas { display: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal.open { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 500px; position: relative; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto;}
        .close-modal { position: absolute; left: 20px; top: 20px; font-size: 1.5rem; cursor: pointer; color: #888; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Toast Notification */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Responsive */
        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; }
            nav ul { flex-wrap: wrap; justify-content: center; }
            .admin-layout { grid-template-columns: 1fr; }
            .admin-sidebar { margin-bottom: 1rem; display: flex; overflow-x: auto; }
            .admin-menu-item { flex: 0 0 auto; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo-area">
            <i class="fas fa-cross logo-icon"></i>
            <div class="site-title">
                <h1>St. Antonios chruch Minya</h1>
                <p>كنيسة القديس العظيم الأنبا أنطونيوس بالمنيا</p>
            </div>
        </div>
        <nav>
            <ul id="nav-links">
                <!-- Links injected by JS based on auth state -->
            </ul>
        </nav>
        <div class="user-menu" id="user-actions">
            <!-- Buttons injected by JS -->
        </div>
    </header>

    <main>
        <!-- 1. HOME PAGE -->
        <section id="home-section" class="page-section active">
            <div class="hero">
                <h2>أهلاً بك في موقع كنيسة القديس العظيم الأنبا أنطونيوس بالمنيا</h2>
                <p> نهضة القديس الأنبا أنطونيوس.</p>
            </div>
            
            <h3 style="margin-bottom: 15px; color: var(--primary-blue);">آخر الوعظ والعظات</h3>
            <div id="sermons-grid" class="grid-container">
                <!-- Sermons rendered here -->
            </div>
        </section>

        <!-- 2. SERVICES PAGE -->
        <section id="services-section" class="page-section">
            <h2 style="margin-bottom: 20px; color: var(--primary-blue);">خدمات الكنيسة</h2>
            <div class="grid-container" id="services-grid">
                <!-- Services rendered here -->
            </div>
        </section>

        <!-- 3. EXAMS PAGE -->
        <section id="exams-section" class="page-section">
            <h2 style="margin-bottom: 20px; color: var(--primary-blue);">الامتحانات والشهادات</h2>
            <div class="grid-container" id="exams-grid">
                <!-- Exams rendered here -->
            </div>
        </section>

        <!-- 4. LEADERBOARD PAGE -->
        <section id="leaderboard-section" class="page-section">
            <h2 style="margin-bottom: 20px; color: var(--primary-blue);">لوحة أبطال المعرفة (أوائل 10)</h2>
            <div class="card">
                <table id="top10-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم المستخدم</th>
                            <th>الامتحان</th>
                            <th>الدرجة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- 5. ADMIN DASHBOARD -->
        <section id="admin-section" class="page-section">
            <div class="admin-layout">
                <aside class="admin-sidebar">
                    <div class="admin-menu-item active" onclick="app.switchAdminTab('users')"><i class="fas fa-users"></i> المستخدمين</div>
                    <div class="admin-menu-item" onclick="app.switchAdminTab('services')"><i class="fas fa-church"></i> الخدمات</div>
                    <div class="admin-menu-item" onclick="app.switchAdminTab('content')"><i class="fas fa-book-open"></i> الوعظ والامتحانات</div>
                    <div class="admin-menu-item" onclick="app.switchAdminTab('results')"><i class="fas fa-chart-bar"></i> النتائج</div>
                    <div class="admin-menu-item" onclick="app.switchAdminTab('certificate')"><i class="fas fa-certificate"></i> إدارة الشهادات</div>
                </aside>
                <div class="admin-content" id="admin-content-area">
                    <!-- Dynamic Admin Content -->
                </div>
            </div>
        </section>

        <!-- 6. LOGIN / REGISTER -->
        <section id="auth-section" class="page-section">
            <div class="form-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 id="auth-title" style="color: var(--primary-blue);">تسجيل الدخول</h2>
                </div>
                <form id="auth-form">
                    <div class="form-group" id="name-group" style="display:none;">
                        <label>الاسم الثلاثي</label>
                        <input type="text" id="auth-name" placeholder="الاسم بالكامل">
                    </div>
                    <div class="form-group" id="phone-group" style="display:none;">
                        <label>رقم الموبايل</label>
                        <input type="tel" id="auth-phone" placeholder="01xxxxxxxxx">
                    </div>
                    <div class="form-group" id="member-group" style="display:none;">
                        <label>هل أنت من أبناء الكنيسة؟</label>
                        <select id="auth-is-member">
                            <option value="false">لا (زائر)</option>
                            <option value="true">نعم</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="auth-email" required>
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور</label>
                        <input type="password" id="auth-password" required>
                    </div>
                    <button type="submit" class="btn-gold" style="width: 100%;">دخول</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    <span id="auth-switch-text">ليس لديك حساب؟</span>
                    <a href="#" style="color: var(--primary-blue); font-weight: bold;" onclick="app.toggleAuthMode()">اضغط هنا</a>
                </p>
            </div>
        </section>
        
        <!-- EXAM TAKING PAGE -->
        <section id="exam-taking-section" class="page-section">
            <div class="form-container" style="max-width: 800px;">
                <h2 id="taking-exam-title" style="margin-bottom: 20px;">عنوان الامتحان</h2>
                <div id="exam-questions-container">
                    <!-- Questions injected here -->
                </div>
                <button class="btn-gold" style="width: 100%; margin-top: 20px;" onclick="app.submitExam()">تسليم الاجابة</button>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="service-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.closeModal('service-modal')">&times;</span>
            <h3 style="text-align: center; color: var(--primary-blue);">تأكيد الدخول للخدمة</h3>
            <p style="text-align: center; margin-bottom: 15px;">هذه الخدمة محمية بكلمة مرور.</p>
            <div class="form-group">
                <label>كلمة سر الخدمة</label>
                <input type="password" id="service-pass-input">
            </div>
            <button class="btn-gold" style="width: 100%;" onclick="app.checkServicePassword()">دخول</button>
        </div>
    </div>

    <div id="cert-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-modal" onclick="app.closeModal('cert-modal')">&times;</span>
            <h3 style="color: var(--success); margin-bottom: 10px;">مبروك! نجحت في الامتحان</h3>
            <p>درجتك: <strong id="cert-score-display">0%</strong></p>
            <div style="margin: 20px 0; border: 1px solid #ddd; padding: 5px; display: inline-block;">
                <img id="generated-cert-img" src="" alt="Certificate" style="max-width: 100%; height: auto;">
            </div>
            <br>
            <a id="download-cert-link" class="btn-gold" download="certificate.png">تحميل الشهادة</a>
        </div>
    </div>

    <!-- Canvas for Certificate Generation -->
    <canvas id="certCanvas"></canvas>

    <!-- Toast -->
    <div id="toast" class="toast">تمت العملية بنجاح</div>

    <script>

        // --- DATA & STATE MANAGEMENT ---
        const MOCK_DB = {
            users: [
                { id: 1, name: "الأب الراعي", email: "admin@st.com", password: "admin", role: "admin", isMember: true, isApproved: true },
                { id: 2, name: "مينا سامي", email: "mina@st.com", password: "123", role: "user", isMember: true, isApproved: true, phone: "01000000001" },
                { id: 3, name: "مارينا جورج", email: "marina@st.com", password: "123", role: "user", isMember: true, isApproved: true, phone: "01000000002" }
            ],
            services: [
                { id: 1, name: "خدمة الإعدادية", password: "prep", icon: "fa-child" },
                { id: 2, name: "خدمة الجامعة", password: "uni", icon: "fa-graduation-cap" },
                { id: 3, name: "خدام", password: "servants", icon: "fa-hands-helping" }
            ],
            sermons: [
                { id: 1, title: "حياة القديس أنطونيوس", content: "دراسة عن جهاد الآباء...", serviceId: 2, date: "2023-10-01" },
                { id: 2, title: "الصلاة في حياتنا", content: "مهمة الصلاة المستمرة...", serviceId: null, date: "2023-10-05" }
            ],
            exams: [
                { id: 1, title: "امتحان القديس أنطونيوس", sermonId: 1, questions: [
                    { q: "أين ولد القديس أنطونيوس؟", options: ["المنيا", "صعيد مصر", "الإسكندرية"], correct: 1 },
                    { q: "كم سنة قضاها في الوحي؟", options: ["20 سنة", "70 سنة", "40 سنة"], correct: 2 }
                ]},
                { id: 2, title: "امتحان الصلاة", sermonId: 2, questions: [
                    { q: "ما هي صلاة يسوع؟", options: ["أبانا الذي", "يا رب يسوع المسيح ابن الله ارحمني أنا الخاطئ", "السلام الملائكي"], correct: 1 }
                ]}
            ],
            results: [
                { id: 1, userId: 2, examId: 1, score: 50 },
                { id: 2, userId: 2, examId: 2, score: 100 },
                { id: 3, userId: 3, examId: 1, score: 100 }
            ],
            certImage: null // Will hold Base64 of uploaded cert
        };

        class App {
            constructor() {
                this.user = null; // Current logged in user
                this.isSupabase = false; // Flag for backend mode
                this.supabase = null;
                this.currentView = 'home';
                this.tempExamId = null;
                this.unlockedServices = []; // List of service IDs unlocked in this session
                
                // Initialize Supabase
                this.initSupabase();
                
                this.loadState();
                this.initUI();
            }

            initSupabase() {
                // ⚠️ Replace these with your Supabase credentials from: https://supabase.com
                const SUPABASE_URL = 'https://fpgphhsovvmqkbzbexmx.supabase.co'; // e.g., https://your-project.supabase.co
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3BoaHNvdnZtcWtiemJleG14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NTg4MzAsImV4cCI6MjA4NDIzNDgzMH0.sywAyESQZWrQY4x_yaoW3uIz4ayBvZCZgyDMQUM2VNM'; // Your public anon key
                
                if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                    this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.isSupabase = true;
                    console.log('✅ Supabase Connected');
                } else {
                    console.log('⚠️ Using Mock Database - Please configure Supabase credentials');
                    this.isSupabase = false;
                }
            }

            // --- AUTHENTICATION ---
            async login(email, password) {
                if(this.isSupabase) {
                    // Real Supabase Logic
                    let { data, error } = await this.supabase.auth.signInWithPassword({ email, password });
                    if (error) return this.toast(error.message, 'error');
                    // Fetch profile
                    const { data: profile, error: profileError } = await this.supabase.from('profiles').select('*').eq('id', data.user.id).single();
                    if (profileError || !profile.is_approved) {
                        await this.supabase.auth.signOut();
                        return this.toast('حسابك قيد المراجعة من قبل الأدمن', 'error');
                    }
                    this.user = {
                        id: profile.id,
                        name: profile.name,
                        email: profile.email,
                        phone: profile.phone,
                        isMember: profile.is_member,
                        isApproved: profile.is_approved,
                        role: profile.role
                    };
                } else {
                    // Mock Logic
                    const u = MOCK_DB.users.find(u => u.email === email && u.password === password);
                    if (!u) return this.toast('بيانات الدخول غير صحيحة', 'error');
                    if (!u.isApproved) return this.toast('حسابك قيد المراجعة من قبل الأدمن', 'error');
                    this.user = u;
                }
                this.saveState();
                this.toast(`أهلاً يا ${this.user.name}`, 'success');
                this.initUI();
            }

            async register(name, email, password, phone, isMember) {
                isMember = (isMember === 'true');
                if(this.isSupabase) {
                    // Real Supabase Logic
                    let { data, error } = await this.supabase.auth.signUp({ email, password });
                    if(error) return this.toast(error.message, 'error');
                    
                    const { error: insertError } = await this.supabase.from('profiles').insert([{ 
                        id: data.user.id, 
                        name, 
                        email,
                        phone, 
                        is_member: isMember, 
                        role: 'user', 
                        is_approved: false 
                    }]);
                    
                    if(insertError) return this.toast('خطأ في التسجيل: ' + insertError.message, 'error');
                    this.toast('تم التسجيل! يرجى انتظار قبول الأدمن.', 'success');
                } else {
                    // Mock logic
                    const exists = MOCK_DB.users.find(u => u.email === email);
                    if(exists) return this.toast('البريد الإلكتروني مسجل مسبقاً', 'error');
                    const newUser = {
                        id: Date.now(),
                        name, email, password, phone,
                        isMember: isMember,
                        role: 'user',
                        isApproved: false // Pending
                    };
                    MOCK_DB.users.push(newUser);
                    this.toast('تم التسجيل! يرجى انتظار قبول الأدمن.', 'success');
                }
                this.toggleAuthMode(); // Switch back to login
            }

            logout() {
                this.user = null;
                this.unlockedServices = [];
                this.saveState();
                window.location.reload();
            }

            // --- NAVIGATION & UI ---
            initUI() {
                this.renderNav();
                // If user is logged in, go to dashboard, else home
                if(!this.user) {
                    this.navigate('home');
                    document.getElementById('user-actions').innerHTML = `<button class="btn-outline" onclick="app.navigate('auth')">تسجيل / دخول</button>`;
                } else {
                    if(this.user.role === 'admin') this.navigate('admin');
                    else this.navigate('home');
                    
                    document.getElementById('user-actions').innerHTML = `
                        <span style="color: white; font-weight: bold;">${this.user.name}</span>
                        <button class="btn-gold" onclick="app.logout()">خروج</button>
                    `;
                }
                this.loadPageContent();
            }

            renderNav() {
                const nav = document.getElementById('nav-links');
                let links = `<li><a onclick="app.navigate('home')">الرئيسية</a></li>`;
                
                if (this.user) {
                    if(this.user.isMember) {
                        links += `<li><a onclick="app.navigate('services')">الخدمات</a></li>`;
                    }
                    links += `<li><a onclick="app.navigate('exams')">الامتحانات</a></li>`;
                    links += `<li><a onclick="app.navigate('leaderboard')">الأوائل</a></li>`;
                    if(this.user.role === 'admin') {
                        links += `<li><a onclick="app.navigate('admin')" style="color:var(--accent-gold)">لوحة التحكم</a></li>`;
                    }
                }
                nav.innerHTML = links;
            }

            navigate(pageId) {
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById(pageId + '-section').classList.add('active');
                this.currentView = pageId;
                this.loadPageContent();
            }

            loadPageContent() {
                if(this.currentView === 'home') this.renderSermons();
                if(this.currentView === 'services') this.renderServices();
                if(this.currentView === 'exams') this.renderExams();
                if(this.currentView === 'leaderboard') this.renderLeaderboard();
                if(this.currentView === 'admin' && this.user?.role === 'admin') this.switchAdminTab('users');
            }

            // --- FEATURES LOGIC ---

            // Services
            async renderServices() {
                const grid = document.getElementById('services-grid');
                let services = [];
                
                if(this.isSupabase) {
                    const { data, error } = await this.supabase.from('services').select('*');
                    if(error) console.error(error);
                    services = data || [];
                } else {
                    services = MOCK_DB.services;
                }
                
                grid.innerHTML = services.map(s => {
                    const isLocked = !this.unlockedServices.includes(s.id);
                    return `
                    <div class="card service-card">
                        ${isLocked ? `
                            <div class="locked-overlay">
                                <i class="fas fa-lock lock-icon"></i>
                                <p>محمية بكلمة مرور</p>
                                <button class="btn-gold" onclick="app.openServiceModal(${s.id})">فتح الخدمة</button>
                            </div>
                        ` : '<div class="unlocked-badge" style="position:absolute; top:10px; left:10px; color:green;"><i class="fas fa-check-circle"></i></div>'}
                        <i class="fas ${s.icon} service-icon"></i>
                        <h3>${s.name}</h3>
                        <p class="card-meta">${isLocked ? 'انقر للدخول' : 'محتوى متاح'}</p>
                        ${!isLocked ? `<div style="margin-top:10px;"><button class="btn-outline" onclick="app.filterSermonsByService(${s.id})">عرض الوعظ</button></div>` : ''}
                    </div>`;
                }).join('');
            }

            openServiceModal(id) {
                this.tempServiceId = id;
                document.getElementById('service-modal').classList.add('open');
            }
            
            checkServicePassword() {
                const input = document.getElementById('service-pass-input').value;
                const service = MOCK_DB.services.find(s => s.id === this.tempServiceId);
                if (service && service.password === input) {
                    this.unlockedServices.push(service.id);
                    this.toast('تم فتح الخدمة بنجاح', 'success');
                    this.closeModal('service-modal');
                    this.renderServices();
                } else {
                    this.toast('كلمة المرور غير صحيحة', 'error');
                }
            }

            // Sermons
            renderSermons(serviceId = null) {
                const container = document.getElementById('sermons-grid');
                let list = MOCK_DB.sermons;
                if(serviceId) list = list.filter(s => s.serviceId === serviceId);
                
                container.innerHTML = list.map(s => `
                    <div class="card">
                        <h3>${s.title}</h3>
                        <div class="card-meta">
                            <span><i class="far fa-calendar"></i> ${s.date}</span>
                            <span><i class="fas fa-tag"></i> ${s.serviceId ? MOCK_DB.services.find(ser=>ser.id===s.serviceId).name : 'عام'}</span>
                        </div>
                        <p>${s.content}</p>
                    </div>
                `).join('');
            }
            
            filterSermonsByService(id) {
                this.navigate('home'); // Or a dedicated service page view
                this.renderSermons(id);
                this.toast(`وعظ ${MOCK_DB.services.find(s=>s.id===id).name}`, 'success');
            }

            // Exams
            async renderExams() {
                const container = document.getElementById('exams-grid');
                let exams = [];
                
                if(this.isSupabase) {
                    const { data, error } = await this.supabase.from('exams').select('*');
                    if(error) console.error(error);
                    exams = data || [];
                } else {
                    exams = MOCK_DB.exams;
                }
                
                container.innerHTML = exams.map(e => `
                    <div class="card" style="text-align: center;">
                        <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--primary-blue); margin-bottom:10px;"></i>
                        <h3>${e.title}</h3>
                        <p>عدد الأسئلة: ${e.questions ? e.questions.length : 0}</p>
                        <button class="btn-gold" style="margin-top:15px;" onclick="app.startExam(${e.id})">بدء الامتحان</button>
                    </div>
                `).join('');
            }

            async startExam(id) {
                this.tempExamId = id;
                let exam;
                
                if(this.isSupabase) {
                    const { data: examData } = await this.supabase.from('exams').select('*').eq('id', id).single();
                    const { data: questionsData } = await this.supabase.from('exam_questions').select('*').eq('exam_id', id).order('order_num');
                    exam = { ...examData, questions: questionsData };
                } else {
                    exam = MOCK_DB.exams.find(e => e.id === id);
                }
                
                document.getElementById('taking-exam-title').innerText = exam.title;
                const container = document.getElementById('exam-questions-container');
                container.innerHTML = exam.questions.map((q, idx) => `
                    <div class="card" style="margin-bottom: 15px;">
                        <p style="font-weight:bold; margin-bottom:10px;">${idx+1}. ${q.q || q.question}</p>
                        ${(q.options || q.options).map((opt, oIdx) => `
                            <div style="margin: 5px 0;">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                    <input type="radio" name="q${idx}" value="${oIdx}"> ${opt}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                this.navigate('exam-taking');
            }

            submitExam() {
                const exam = MOCK_DB.exams.find(e => e.id === this.tempExamId);
                let score = 0;
                let total = exam.questions.length;
                
                exam.questions.forEach((q, idx) => {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if(selected && parseInt(selected.value) === (q.correct || q.correct_answer)) {
                        score++;
                    }
                });

                const percentage = Math.round((score / total) * 100);
                
                // Save Result
                if(this.isSupabase) {
                    this.supabase.from('exam_results').insert({
                        user_id: this.user.id,
                        exam_id: exam.id,
                        score: score,
                        percentage: percentage
                    }).then(() => console.log('Result saved'));
                } else {
                    MOCK_DB.results.push({
                        id: Date.now(),
                        userId: this.user.id,
                        examId: exam.id,
                        score: percentage
                    });
                }

                // Generate Certificate
                this.generateCertificate(this.user.name, exam.title, percentage);
                
                // Show Modal
                document.getElementById('cert-score-display').innerText = percentage + "%";
                document.getElementById('cert-modal').classList.add('open');
                this.navigate('exams'); // reset view behind modal
            }

            // Certificate Generation (Canvas)
            generateCertificate(name, title, score) {
                const canvas = document.getElementById('certCanvas');
                const ctx = canvas.getContext('2d');
                
                // Default settings
                canvas.width = 800;
                canvas.height = 600;
                
                // Background
                if(MOCK_DB.certImage) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        this.drawText(ctx, name, title, score);
                    };
                    img.src = MOCK_DB.certImage;
                } else {
                    // Fallback Design
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(0,0,canvas.width, canvas.height);
                    ctx.strokeStyle = "#c5a059";
                    ctx.lineWidth = 10;
                    ctx.strokeRect(0,0,canvas.width, canvas.height);
                    this.drawText(ctx, name, title, score);
                }
            }

            drawText(ctx, name, title, score) {
                ctx.textAlign = "center";
                ctx.fillStyle = "#1a2b49";
                
                ctx.font = "bold 40px Tajawal";
                ctx.fillText("شهادة تقدير", 400, 100);
                
                ctx.font = "20px Tajawal";
                ctx.fillStyle = "#555";
                ctx.fillText(`تشهد كنيسة القديس الأنبا أنطونيوس بأن الطالب/ة:`, 400, 200);
                
                ctx.font = "bold 50px Tajawal";
                ctx.fillStyle = "#c5a059";
                ctx.fillText(name, 400, 270);
                
                ctx.font = "20px Tajawal";
                ctx.fillStyle = "#555";
                ctx.fillText(`قد أتم امتحان: ${title} بنجاح`, 400, 340);
                
                ctx.font = "bold 60px Tajawal";
                ctx.fillStyle = score >= 80 ? "#28a745" : "#dc3545";
                ctx.fillText(`${score}%`, 400, 450);

                // Export to Image
                const dataUrl = document.getElementById('certCanvas').toDataURL('image/png');
                document.getElementById('generated-cert-img').src = dataUrl;
                document.getElementById('download-cert-link').href = dataUrl;
            }

            // Leaderboard
            async renderLeaderboard() {
                const tbody = document.querySelector('#top10-table tbody');
                let results = [];
                
                if(this.isSupabase) {
                    const { data } = await this.supabase
                        .from('exam_results')
                        .select('*, profiles(name), exams(title)')
                        .order('percentage', { ascending: false })
                        .limit(10);
                    results = data || [];
                } else {
                    results = [...MOCK_DB.results].sort((a,b) => b.score - a.score).slice(0, 10);
                }
                
                tbody.innerHTML = results.map((r, i) => {
                    let userName = r.profiles?.name || (MOCK_DB.users.find(u => u.id === r.userId)?.name) || 'Unknown';
                    let examTitle = r.exams?.title || (MOCK_DB.exams.find(e => e.id === r.examId)?.title) || 'Unknown';
                    let score = r.percentage || r.score;
                    
                    return `
                        <tr>
                            <td>${i+1}</td>
                            <td>${userName}</td>
                            <td>${examTitle}</td>
                            <td><span style="font-weight:bold; color: ${score >= 80 ? 'green':'red'}">${score}%</span></td>
                        </tr>
                    `;
                }).join('');
            }

            // --- ADMIN PANEL (Updated) ---
            async switchAdminTab(tab) {
                // Update sidebar active state
                document.querySelectorAll('.admin-menu-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`.admin-menu-item[onclick="app.switchAdminTab('${tab}')"]`).classList.add('active');
                
                const area = document.getElementById('admin-content-area');
                
                if(tab === 'users') {
                    let users = MOCK_DB.users;
                    if(this.isSupabase) {
                        const { data } = await this.supabase.from('profiles').select('*');
                        users = data?.map(p => ({
                            id: p.id,
                            name: p.name,
                            email: p.email,
                            isApproved: p.is_approved,
                            role: p.role,
                            isMember: p.is_member
                        })) || users;
                    }
                    
                    area.innerHTML = `
                        <h3>إدارة المستخدمين</h3>
                        <table>
                            <thead><tr><th>الاسم</th><th>البريد</th><th>الحالة</th><th>الدور</th><th>إجراءات</th></tr></thead>
                            <tbody>
                                ${users.map(u => `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>${u.isApproved ? '<span style="color:green">نشط</span>' : '<span style="color:red">قيد المراجعة</span>'}</td>
                                        <td>${u.role === 'admin' ? '<b>أدمن</b>' : 'مستخدم'}</td>
                                        <td style="display:flex; gap:5px;">
                                            ${!u.isApproved ? `
                                                <button class="btn-gold" onclick="app.approveUser(${u.id})">قبول</button>
                                                <button class="btn-outline" style="color:red; border-color:red;" onclick="app.rejectUser(${u.id})">رفض</button>
                                            ` : `
                                                <button class="btn-outline" onclick="app.toggleAdmin(${u.id})">${u.role === 'admin' ? 'إلغاء صلاحية' : 'ترقية لأدمن'}</button>
                                                <button class="btn-outline" style="color:red; border-color:red;" onclick="app.rejectUser(${u.id})">حذف/رفض</button>
                                            `}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'services') {
                    let services = MOCK_DB.services;
                    if(this.isSupabase) {
                        const { data } = await this.supabase.from('services').select('*');
                        services = data || services;
                    }
                    
                    area.innerHTML = `
                        <h3>إدارة الخدمات</h3>
                        <div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px;">
                            <h4>إضافة خدمة جديدة</h4>
                            <input type="text" id="new-serv-name" placeholder="اسم الخدمة" style="margin:5px 0; padding:5px;">
                            <input type="text" id="new-serv-pass" placeholder="كلمة المرور" style="margin:5px 0; padding:5px;">
                            <button class="btn-gold" onclick="app.addService()">إضافة</button>
                        </div>
                        <ul>
                            ${services.map(s => `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${s.name} (${s.password})</span> <button onclick="app.deleteService(${s.id})" style="color:red; background:none; border:none; cursor:pointer;">حذف</button></li>`).join('')}
                        </ul>
                    `;
                } else if (tab === 'content') {
                    let sermons = MOCK_DB.sermons;
                    let services = MOCK_DB.services;
                    
                    if(this.isSupabase) {
                        const { data: sData } = await this.supabase.from('sermons').select('*');
                        const { data: servData } = await this.supabase.from('services').select('*');
                        sermons = sData || sermons;
                        services = servData || services;
                    }
                    
                    // NEW CONTENT MANAGEMENT LOGIC
                    area.innerHTML = `
                        <div class="admin-sub-tabs">
                            <div class="sub-tab active" onclick="app.switchContentSubTab('sermon')">إضافة وعظ</div>
                            <div class="sub-tab" onclick="app.switchContentSubTab('exam')">إنشاء امتحان</div>
                        </div>
                        <div id="content-sermon-panel">
                            <h3>إضافة وعظ جديد</h3>
                            <div class="form-group">
                                <label>عنوان الوعظ</label>
                                <input type="text" id="new-sermon-title">
                            </div>
                            <div class="form-group">
                                <label>محتوى الوعظ</label>
                                <textarea id="new-sermon-content" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label>الخدمة المرتبطة (اختياري)</label>
                                <select id="new-sermon-service">
                                    <option value="">عام</option>
                                    ${services.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <button class="btn-gold" onclick="app.addSermon()">حفظ الوعظ</button>
                        </div>

                        <div id="content-exam-panel" style="display:none;">
                            <h3>إنشاء امتحان جديد</h3>
                            <div class="form-group">
                                <label>عنوان الامتحان</label>
                                <input type="text" id="new-exam-title">
                            </div>
                            <div class="form-group">
                                <label>الوعظ المرتبط</label>
                                <select id="new-exam-sermon">
                                    ${sermons.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                </select>
                            </div>
                            
                            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
                            <h4>أسئلة الامتحان</h4>
                            <div id="questions-container"></div>
                            
                            <button class="btn-outline" style="margin-top:10px;" onclick="app.addQuestionInput()">+ إضافة سؤال</button>
                            <br><br>
                            <button class="btn-gold" onclick="app.saveNewExam()">حفظ الامتحان</button>
                        </div>
                    `;
                    // Add initial empty question
                    this.addQuestionInput();

                } else if (tab === 'results') {
                    let results = MOCK_DB.results;
                    if(this.isSupabase) {
                        const { data } = await this.supabase
                            .from('exam_results')
                            .select('*, profiles(name), exams(title)');
                        if(data) {
                            results = data.map(r => ({
                                userId: r.user_id,
                                examId: r.exam_id,
                                score: r.percentage,
                                userName: r.profiles?.name,
                                examTitle: r.exams?.title
                            }));
                        }
                    }
                    
                    area.innerHTML = `
                        <h3>نتائج الامتحانات التفصيلية</h3>
                        <table>
                            <thead><tr><th>المستخدم</th><th>الامتحان</th><th>الدرجة</th></tr></thead>
                            <tbody>
                                ${results.map(r => {
                                    let userName = r.userName || (MOCK_DB.users.find(u=>u.id===r.userId)?.name) || 'Unknown';
                                    let examTitle = r.examTitle || (MOCK_DB.exams.find(e=>e.id===r.examId)?.title) || 'Unknown';
                                    return `
                                        <tr>
                                            <td>${userName}</td>
                                            <td>${examTitle}</td>
                                            <td>${r.score}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'certificate') {
                    area.innerHTML = `
                        <h3>إدارة الشهادات</h3>
                        <p>ارفع صورة الشهادة الفارغة (Background) وسنقوم بوضع البيانات عليها تلقائياً.</p>
                        <div style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px;">
                            <input type="file" id="cert-upload" accept="image/*" onchange="app.handleCertUpload(this)">
                            <p style="margin-top:10px; color:#777;">الصور المدعومة: PNG, JPG</p>
                        </div>
                        ${MOCK_DB.certImage ? `<img src="${MOCK_DB.certImage}" style="max-width:200px; margin-top:10px; border:1px solid #ccc;">` : ''}
                    `;
                }
            }

            // --- ADMIN ACTIONS: USERS ---
            approveUser(id) {
                const u = MOCK_DB.users.find(x => x.id === id);
                if(u) u.isApproved = true;
                this.switchAdminTab('users');
                this.toast('تم تفعيل المستخدم', 'success');
            }

            rejectUser(id) {
                if(confirm('هل أنت متأكد من حذف/رفض هذا المستخدم؟')) {
                    MOCK_DB.users = MOCK_DB.users.filter(u => u.id !== id);
                    this.switchAdminTab('users');
                    this.toast('تم رفض/حذف المستخدم', 'error');
                }
            }

            toggleAdmin(id) {
                const u = MOCK_DB.users.find(x => x.id === id);
                if(u) u.role = u.role === 'admin' ? 'user' : 'admin';
                this.switchAdminTab('users');
                this.toast('تم تحديث الصلاحيات', 'success');
            }

            // --- ADMIN ACTIONS: SERVICES ---
            addService() {
                const name = document.getElementById('new-serv-name').value;
                const pass = document.getElementById('new-serv-pass').value;
                if(name && pass) {
                    MOCK_DB.services.push({ id: Date.now(), name, password: pass, icon: 'fa-church' });
                    this.switchAdminTab('services');
                    this.toast('تمت إضافة الخدمة', 'success');
                }
            }

            deleteService(id) {
                if(confirm('حذف الخدمة؟')) {
                    MOCK_DB.services = MOCK_DB.services.filter(s => s.id !== id);
                    this.switchAdminTab('services');
                }
            }

            // --- ADMIN ACTIONS: CONTENT (New) ---
            switchContentSubTab(tab) {
                const sermonsPanel = document.getElementById('content-sermon-panel');
                const examsPanel = document.getElementById('content-exam-panel');
                const tabs = document.querySelectorAll('.sub-tab');

                tabs.forEach(t => t.classList.remove('active'));
                
                if(tab === 'sermon') {
                    sermonsPanel.style.display = 'block';
                    examsPanel.style.display = 'none';
                    tabs[0].classList.add('active');
                } else {
                    sermonsPanel.style.display = 'none';
                    examsPanel.style.display = 'block';
                    tabs[1].classList.add('active');
                }
            }

            addSermon() {
                const title = document.getElementById('new-sermon-title').value;
                const content = document.getElementById('new-sermon-content').value;
                const serviceId = document.getElementById('new-sermon-service').value;
                
                if(!title || !content) return this.toast('يرجى ملء البيانات', 'error');

                MOCK_DB.sermons.push({
                    id: Date.now(),
                    title,
                    content,
                    serviceId: serviceId ? parseInt(serviceId) : null,
                    date: new Date().toISOString().split('T')[0]
                });
                
                this.toast('تم إضافة الوعظ بنجاح', 'success');
                document.getElementById('new-sermon-title').value = '';
                document.getElementById('new-sermon-content').value = '';
            }

            addQuestionInput() {
                const container = document.getElementById('questions-container');
                const div = document.createElement('div');
                div.className = 'question-block';
                div.innerHTML = `
                    <i class="fas fa-times remove-q-btn" onclick="this.parentElement.remove()"></i>
                    <div class="form-group">
                        <label>نص السؤال</label>
                        <input type="text" class="q-text">
                    </div>
                    <label>الخيارات (حدد الإجابة الصحيحة):</label>
                    <div class="option-row"><input type="radio" name="q-${Date.now()}-correct" value="0" checked> <input type="text" class="opt-0" placeholder="الخيار 1"></div>
                    <div class="option-row"><input type="radio" name="q-${Date.now()}-correct" value="1"> <input type="text" class="opt-1" placeholder="الخيار 2"></div>
                    <div class="option-row"><input type="radio" name="q-${Date.now()}-correct" value="2"> <input type="text" class="opt-2" placeholder="الخيار 3"></div>
                `;
                container.appendChild(div);
            }

            saveNewExam() {
                const title = document.getElementById('new-exam-title').value;
                const sermonId = document.getElementById('new-exam-sermon').value;
                const qBlocks = document.querySelectorAll('.question-block');

                if(!title || qBlocks.length === 0) return this.toast('بيانات ناقصة', 'error');

                const questions = [];
                qBlocks.forEach(block => {
                    const qText = block.querySelector('.q-text').value;
                    const opt0 = block.querySelector('.opt-0').value;
                    const opt1 = block.querySelector('.opt-1').value;
                    const opt2 = block.querySelector('.opt-2').value;
                    const correctVal = block.querySelector('input[type="radio"]:checked').value;

                    if(qText && opt0 && opt1 && opt2) {
                        questions.push({
                            q: qText,
                            options: [opt0, opt1, opt2],
                            correct: parseInt(correctVal)
                        });
                    }
                });

                if(questions.length === 0) return this.toast('يرجى إضافة سؤال واحد صحيح على الأقل', 'error');

                MOCK_DB.exams.push({
                    id: Date.now(),
                    title,
                    sermonId: parseInt(sermonId),
                    questions
                });

                this.toast('تم حفظ الامتحان بنجاح', 'success');
                // Reset UI logic could go here
            }

            handleCertUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        MOCK_DB.certImage = e.target.result;
                        app.switchAdminTab('certificate'); // refresh
                        app.toast('تم تحديث صورة الشهادة', 'success');
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            // --- HELPERS ---
            toggleAuthMode() {
                const isLogin = document.getElementById('auth-title').innerText.includes('دخول');
                const title = document.getElementById('auth-title');
                const nameGrp = document.getElementById('name-group');
                const phoneGrp = document.getElementById('phone-group');
                const memberGrp = document.getElementById('member-group');
                const switchTxt = document.getElementById('auth-switch-text');
                const btn = document.querySelector('#auth-form button');

                if(isLogin) {
                    title.innerText = "إنشاء حساب جديد";
                    nameGrp.style.display = "block";
                    phoneGrp.style.display = "block";
                    memberGrp.style.display = "block";
                    switchTxt.innerText = "لديك حساب بالفعل؟";
                    btn.innerText = "تسجيل";
                } else {
                    title.innerText = "تسجيل الدخول";
                    nameGrp.style.display = "none";
                    phoneGrp.style.display = "none";
                    memberGrp.style.display = "none";
                    switchTxt.innerText = "ليس لديك حساب؟";
                    btn.innerText = "دخول";
                }
            }

            closeModal(id) {
                document.getElementById(id).classList.remove('open');
            }

            toast(msg, type = 'success') {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.className = `toast show ${type}`;
                setTimeout(() => t.className = 'toast', 3000);
            }

            loadState() {
                const savedUser = localStorage.getItem('st_antonios_user');
                if(savedUser) this.user = JSON.parse(savedUser);
            }

            saveState() {
                if(this.user) localStorage.setItem('st_antonios_user', JSON.stringify(this.user));
                else localStorage.removeItem('st_antonios_user');
            }
        }

        // Initialize App
        const app = new App();

        // --- ANTI-SCREENSHOT & ANTI-COPY PROTECTION ---
        // منع النسخ
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            app.toast('❌ النسخ غير مسموح به', 'error');
            return false;
        });

        // منع قائمة السياق (كلك يميني)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            app.toast('❌ هذه العملية غير مسموح بها', 'error');
            return false;
        });

        // منع الطباعة (Ctrl+P)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                app.toast('❌ الطباعة غير مسموح بها', 'error');
                return false;
            }
            // منع Ctrl+S
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                app.toast('❌ الحفظ غير مسموح به', 'error');
                return false;
            }
            // منع Ctrl+Shift+I (Developer Tools)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            // منع F12 (Developer Tools)
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
        });

        // منع اختيار النص (Select)
        document.addEventListener('selectstart', (e) => {
            e.preventDefault();
            return false;
        });

        // منع القص (Cut - Ctrl+X)
        document.addEventListener('cut', (e) => {
            e.preventDefault();
            app.toast('❌ القص غير مسموح به', 'error');
            return false;
        });

        // منع Drag و Drop
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
            return false;
        });

        // تعطيل الفحص (Inspect Element) من خلال عدة طرق
        window.addEventListener('error', (e) => {
            if (e.message.includes('Uncaught')) {
                // محاولة منع أدوات المطورين
            }
        });

        // منع Screenshot عبر keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // منع PrtScn (Print Screen)
            if (e.key === 'PrintScreen') {
                e.preventDefault();
                app.toast('❌ أخذ لقطات الشاشة غير مسموح به', 'error');
                return false;
            }
        });

        // Handle Form Submission
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            const isLogin = document.getElementById('auth-title').innerText.includes('دخول');

            if(isLogin) {
                await app.login(email, pass);
            } else {
                const name = document.getElementById('auth-name').value;
                const phone = document.getElementById('auth-phone').value;
                const isMember = document.getElementById('auth-is-member').value;
                await app.register(name, email, pass, phone, isMember);
            }
        });

    </script>
</body>
</html>
